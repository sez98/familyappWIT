var data = [
    {
        "u1": {
            "username": "sezal",
            "name": "Sezal Chug",
            "gender": "Female",
            "email": "sezal@gmail.com",
            "password": "sezalchug",
            "dob": "28-11-1998",
            "doa": null,
            "children": [],
            "mom_username": "anuradha",
            "dad_username": "pramod",
            "married": "No",
            "spouse_username": null,
            "bloodGroup": "O+",
            "profession": null,
            "state": null,
            "country": null,
            "diseases": null,
            "hobbies": [
                "Coding",
                "Netflix",
                "Music"
            ],
            "reviews": null,
            "posts": null
        },
        "root": true,
        "k": 0,
        "flag": true
    },
    {
        "u1": {
            "username": "pramod",
            "name": "Pramod Chug",
            "gender": "Male",
            "email": "pramod@gmail.com",
            "password": "pramodchug",
            "dob": "13-08-1970",
            "doa": "11-02-1997",
            "children": [
                "sezal",
                "naman"
            ],
            "mom_username": "krishnadadi",
            "dad_username": null,
            "married": "Yes",
            "spouse_username": "anuradha",
            "bloodGroup": "O-",
            "profession": null,
            "state": null,
            "country": null,
            "diseases": null,
            "hobbies": [
                "Dog Training",
                "Badminton",
                "Reading",
                "General Awareness"
            ],
            "reviews": null,
            "posts": null
        },
        "root": false,
        "k": 1,
        "flag": false
    },
    {
        "u1": {
            "username": "anuradha",
            "name": "Anuradha Chug",
            "gender": "Female",
            "email": "anuradha@gmail.com",
            "password": "anuradhachug",
            "dob": "02-12-1972",
            "doa": "11-02-1997",
            "children": [
                "sezal",
                "naman"
            ],
            "mom_username": "krishna",
            "dad_username": null,
            "married": "Yes",
            "spouse_username": "pramod",
            "bloodGroup": "O+",
            "profession": null,
            "state": null,
            "country": null,
            "diseases": null,
            "hobbies": [
                "Computers",
                "Education",
                "Cooking"
            ],
            "reviews": null,
            "posts": null
        },
        "root": false,
        "k": 1,
        "flag": true
    },
    {
        "u1": {
            "username": "krishna",
            "name": "Krishna Baweja",
            "gender": "Female",
            "email": "krishna@gmail.com",
            "password": "krishnabaweja",
            "dob": "12-12-1920",
            "doa": "23-04-1944",
            "children": [
                "anuradha",
                "anuju",
                "anuj"
            ],
            "mom_username": null,
            "dad_username": null,
            "married": "Yes",
            "spouse_username": null,
            "bloodGroup": "O+",
            "profession": null,
            "state": null,
            "country": null,
            "diseases": null,
            "hobbies": [
                "Spiritual",
                "Cooking"
            ],
            "reviews": null,
            "posts": null
        },
        "root": false,
        "k": 2,
        "flag": true
    },
    {
        "u1": {
            "username": "naman",
            "name": "naman Chug",
            "gender": "Male",
            "email": "naman@gmail.com",
            "password": "namanchug",
            "dob": "09-07-2006",
            "doa": null,
            "children": [],
            "mom_username": "anuradha",
            "dad_username": "pramod",
            "married": "No",
            "spouse_username": null,
            "bloodGroup": "AB-",
            "profession": null,
            "state": null,
            "country": null,
            "diseases": null,
            "hobbies": [
                "Reading",
                "Badminton",
                "Games"
            ],
            "reviews": null,
            "posts": null
        },
        "root": false,
        "k": 0,
        "flag": true
    },
    {
        "u1": {
            "username": "anuju",
            "name": "Anuju Tinna",
            "gender": "Female",
            "email": "anuju@gmail.com",
            "password": "anujutinna",
            "dob": "23-04-1969",
            "doa": "14-05-1995",
            "children": [
                "parash"
            ],
            "mom_username": "krishna",
            "dad_username": null,
            "married": "Yes",
            "spouse_username": null,
            "bloodGroup": "AB-",
            "profession": null,
            "state": null,
            "country": null,
            "diseases": null,
            "hobbies": [
                "Chemistry",
                "Physics",
                "Education"
            ],
            "reviews": null,
            "posts": null
        },
        "root": false,
        "k": 1,
        "flag": true
    },
    {
        "u1": {
            "username": "anuj",
            "name": "Anuj Baweja",
            "gender": "Male",
            "email": "anuj@gmail.com",
            "password": "anujtinna",
            "dob": "12-03-1964",
            "doa": "10-12-1994",
            "children": [
                "dhruv",
                "saloni"
            ],
            "mom_username": "krishna",
            "dad_username": null,
            "married": "Yes",
            "spouse_username": "shilpi",
            "bloodGroup": "AB+",
            "profession": null,
            "state": null,
            "country": null,
            "diseases": null,
            "hobbies": [
                "Working",
                "Reading",
                "Finance"
            ],
            "reviews": null,
            "posts": null
        },
        "root": false,
        "k": 1,
        "flag": true
    },
    {
        "u1": {
            "username": "parash",
            "name": "Parash Tinna",
            "gender": "Male",
            "email": "parash@gmail.com",
            "password": "parashtinna",
            "dob": "03-01-1994",
            "doa": "23-11-2020",
            "children": [],
            "mom_username": "anuju",
            "dad_username": null,
            "married": "Yes",
            "spouse_username": null,
            "bloodGroup": "O+",
            "profession": null,
            "state": null,
            "country": null,
            "diseases": null,
            "hobbies": [
                "Games",
                "Netflix",
                "Music"
            ],
            "reviews": null,
            "posts": null
        },
        "root": false,
        "k": 0,
        "flag": true
    },
    {
        "u1": {
            "username": "shilpi",
            "name": "Shilpi Baweja",
            "gender": "Female",
            "email": "shilpi@gmail.com",
            "password": "shilpibaweja",
            "dob": "14-03-1970",
            "doa": "23-04-1995",
            "children": [
                "dhruv",
                "saloni"
            ],
            "mom_username": null,
            "dad_username": null,
            "married": "Yes",
            "spouse_username": "anuj",
            "bloodGroup": "AB-",
            "profession": null,
            "state": null,
            "country": null,
            "diseases": null,
            "hobbies": [
                "Spiritual",
                "Cooking",
                "Caring"
            ],
            "reviews": null,
            "posts": null
        },
        "root": false,
        "k": 1,
        "flag": false
    },
    {
        "u1": {
            "username": "dhruv",
            "name": "Dhruv Baweja",
            "gender": "Male",
            "email": "dhruv@gmail.com",
            "password": "dhruvbaweja",
            "dob": "19-05-1995",
            "doa": null,
            "children": [],
            "mom_username": "shilpi",
            "dad_username": "anuj",
            "married": "No",
            "spouse_username": null,
            "bloodGroup": "B-",
            "profession": null,
            "state": null,
            "country": null,
            "diseases": null,
            "hobbies": [
                "Finance",
                "Netflix",
                "Music"
            ],
            "reviews": null,
            "posts": null
        },
        "root": false,
        "k": 0,
        "flag": true
    },
    {
        "u1": {
            "username": "saloni",
            "name": "saloni Baweja",
            "gender": "Female",
            "email": "saloni@gmail.com",
            "password": "salonibaweja",
            "dob": "12-06-1995",
            "doa": null,
            "children": [],
            "mom_username": "shilpi",
            "dad_username": "anuj",
            "married": "No",
            "spouse_username": null,
            "bloodGroup": "O+",
            "profession": null,
            "state": null,
            "country": null,
            "diseases": null,
            "hobbies": [
                "Games",
                "Netflix",
                "Music"
            ],
            "reviews": null,
            "posts": null
        },
        "root": false,
        "k": 0,
        "flag": true
    }
]
, elements = [], root, levels = [], levelMap = [], 
	tree = document.getElementById('tree'), 
	startTop, startLeft, gap = 32, size = 64
;
startTop = (window.innerHeight / 2) - (size / 2);
startLeft = (window.innerWidth / 2) - (size / 2);

data = data.map( ele => {
    let user = {
        ...ele.u1,
        id: ele.u1.username,
        partners: [ele.u1.spouse_username].filter(Boolean),
        parents: [ele.u1.mom_username, ele.u1.dad_username].filter(Boolean)
    };
    return {
        ...user,
        level : ele.k,
        root : ele.root 
    };
});

data.forEach(function(elem) {
	if (levels.indexOf(elem.level) < 0) { levels.push(elem.level); }
});
levels.sort(function(a, b) { return a - b; });

levels.forEach(function(level) {
	var startAt = data.filter(function(person) {
		return person.level == level;
	});
	startAt.forEach(function(start) {
		var person = findPerson(start.id);
		plotNode(person, 'self');
		plotParents(person);
	});
	
});

adjustNegatives();

function plotParents(start) {
	if (! start) { return; }
	start.parents.reduce(function(previousId, currentId) {
		var previousParent = findPerson(previousId), 
			currentParent = findPerson(currentId);
      if(currentParent == undefined) {
      	return;
      }
		plotNode(currentParent, 'parents', start, start.parents.length);
		if (previousParent) { plotConnector(previousParent, currentParent, 'partners'); }
		plotConnector(start, currentParent, 'parents');
		plotParents(currentParent);
		return currentId;
	}, 0);
}

function plotNode() {
	var person = arguments[0], personType = arguments[1], relative = arguments[2], numberOfParents = arguments[3], 
		node = get(person.id), relativeNode, element = {}, thisLevel, exists 
	;
	if (node) { return; }
	node = document.createElement('div'); 
	node.id = person.id; 
	node.classList.add('node'); node.classList.add('asset'); 
	node.textContent = person.name; 
	node.setAttribute('data-level', person.level);

	thisLevel = findLevel(person.level);
	if (! thisLevel) { 
		thisLevel = { 'level': person.level, 'top': startTop }; 
		levelMap.push(thisLevel); 
	}
	
	if (personType == 'self') {
		node.style.left = startLeft + 'px'; 
		node.style.top = thisLevel.top + 'px';
	} else {
		relativeNode = get(relative.id);
	}
	if (personType == 'partners') {
		node.style.left = (parseInt(relativeNode.style.left) + size + (gap * 2)) + 'px';	
		node.style.top = parseInt(relativeNode.style.top) + 'px'; 
	}
	if (personType == 'children') {
		node.style.left = (parseInt(relativeNode.style.left) - size) + 'px';	
		node.style.top = (parseInt(relativeNode.style.top) + size + gap) + 'px'; 							
	}
	if (personType == 'parents') {
		if (numberOfParents == 1) { 
			node.style.left = parseInt(relativeNode.style.left) + 'px'; 
			node.style.top = (parseInt(relativeNode.style.top) - gap - size) + 'px';						
		} else {
			node.style.left = (parseInt(relativeNode.style.left) - size) + 'px'; 
			node.style.top = (parseInt(relativeNode.style.top) - gap - size) + 'px';											
		}
	}
	while (exists = detectCollision(node)) { 
		node.style.left = (exists.left + size + (gap * 2)) + 'px'; 
	}

	if (thisLevel.top > parseInt(node.style.top)) {
		updateLevel(person.level, 'top', parseInt(node.style.top));
	}
	
	element.id = node.id; element.left = parseInt(node.style.left); element.top = parseInt(node.style.top); 
	elements.push(element);
	tree.appendChild(node); 
}

/* Helper Functions */
function get(id) { return document.getElementById(id); }

function findPerson(id) {
	var element = data.filter(function(elem) {
		return elem.id == id;
	});
	return element.pop();
}

function findLevel(level) {
	var element = levelMap.filter(function(elem) {
		return elem.level == level;
	});
	return element.pop();
} 

function updateLevel(id, key, value) {
	levelMap.forEach(function(level) {
		if (level.level === id) {
			level[key] = value;
		}
	});
}

function detectCollision(node) {
	var element = elements.filter(function(elem) { 
		var left = parseInt(node.style.left);
		return ((elem.left == left || (elem.left < left && left < (elem.left + size + gap))) && elem.top == parseInt(node.style.top));
	});
	return element.pop();
}

function adjustNegatives() { 
	var allNodes = document.querySelectorAll('div.asset'), 
		minTop = startTop, diff = 0;
	for (var i=0; i < allNodes.length; i++) {
		if (parseInt(allNodes[i].style.top) < minTop) { minTop = parseInt(allNodes[i].style.top); }
	};
	if (minTop < startTop) {
		diff = Math.abs(minTop) + gap; 
		for (var i=0; i < allNodes.length; i++) {
			allNodes[i].style.top = parseInt(allNodes[i].style.top) + diff + 'px';
		};
	}
}

function plotConnector(source, destination, relation) {
	var connector = document.createElement('div'), 
  		orientation, comboId, comboIdInverse, start, stop, 
			x1, y1, x2, y2, length, angle, transform
	; 
  // We do not plot a connector if already present
  comboId = source.id + '-' + destination.id;
  comboIdInverse = destination.id + '-' + source.id;
  if (document.getElementById(comboId)) { return; }
  if (document.getElementById(comboIdInverse)) { return; }

  connector.id = comboId;
	orientation = relation == 'partners' ? 'h' : 'v';
	connector.classList.add('asset');
	connector.classList.add('connector');
	connector.classList.add(orientation);
	start = get(source.id); stop = get(destination.id);
	if (relation == 'partners') {
		x1 = parseInt(start.style.left) + size; y1 = parseInt(start.style.top) + (size/2);
		x2 = parseInt(stop.style.left); y2 = parseInt(stop.style.top);
		length = (x2 - x1) + 'px';
		
		connector.style.width = length;
		connector.style.left = x1 + 'px';
		connector.style.top = y1 + 'px';
    // Avoid collision moving down
    while (exists = detectConnectorCollision(connector)) { 
      connector.style.top = (parseInt(exists.style.top) + 4) + 'px'; 
    }
	}
	if (relation == 'parents') {
		x1 = parseInt(start.style.left) + (size/2); y1 = parseInt(start.style.top);
		x2 = parseInt(stop.style.left) + (size/2); y2 = parseInt(stop.style.top) + (size - 2);
		
		length = Math.sqrt((x1 - x2) * (x1 - x2) + (y1 - y2) * (y1 - y2));
		angle  = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
		transform = 'rotate(' + angle + 'deg)'; 
		
		connector.style.width = length + 'px';
		connector.style.left = x1 + 'px';
		connector.style.top = y1 + 'px';
		connector.style.transform = transform;
	}
	tree.appendChild(connector);
}

function detectConnectorCollision(connector) {
  var connectors = [].slice.call(document.querySelectorAll('div.connector.h'));
  var element = connectors.filter(function(elem) { 
    return ((elem.style.left == connector.style.left) && (elem.style.top == connector.style.top))
  });
  return element.pop();
}
